name: Daily Portfolio Analytics

on:
  schedule:
    # Lundi-Vendredi Ã  17:00 UTC (18:00 CET / 19:00 CEST)
    - cron: '0 17 * * 1-5'
  
  workflow_dispatch:  # Bouton manuel

permissions:
  contents: write
  actions: read

jobs:
  portfolio-optimization:
    name: Run ML Pipeline & Update Portfolio
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 1. Setup Environment
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
      
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 2. Run Analytics Pipeline
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸš€ Execute Portfolio Optimization
        run: |
          echo "ðŸš€ Starting portfolio analytics pipeline..."
          python daily_run.py
          echo "âœ… Pipeline completed successfully"
        env:
          PYTHONUNBUFFERED: 1
          TZ: Europe/Paris
      
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 3. Verify Generated Files
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ” Check generated files
        run: |
          echo "ðŸ“‚ Checking generated files..."
          ls -lh latest_signals.csv portfolio_history.csv data_metadata.json || echo "Some output files missing"
      
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 4. Commit & Push Results (STRATÃ‰GIE ANTI-CONFLIT)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ’¾ Commit updated data
        run: |
          git config --local user.name 'AlphaML Bot'
          git config --local user.email '41898282+github-actions[bot]@users.noreply.github.com'
          
          # A. SAUVEGARDE TEMPORAIRE DES RÃ‰SULTATS GÃ‰NÃ‰RÃ‰S
          # On met les nouveaux fichiers calculÃ©s Ã  l'abri dans un dossier temporaire
          mkdir -p /tmp/portfolio_data
          cp latest_signals.csv /tmp/portfolio_data/ 2>/dev/null || true
          cp portfolio_history.csv /tmp/portfolio_data/ 2>/dev/null || true
          cp data_metadata.json /tmp/portfolio_data/ 2>/dev/null || true
          cp debug_run.txt /tmp/portfolio_data/ 2>/dev/null || true
          
          # B. NETTOYAGE RADICAL (RESET)
          # On s'assure d'Ãªtre 100% alignÃ© avec le serveur pour supprimer tout conflit fantÃ´me
          git fetch origin main
          git reset --hard origin/main
          
          # C. RESTAURATION DES DONNÃ‰ES
          # On ramÃ¨ne les fichiers frais calculÃ©s par le script
          cp /tmp/portfolio_data/* .
          
          # D. PRÃ‰PARATION DU COMMIT
          # On ajoute uniquement les fichiers CSV/JSON (Pas de parquet !)
          git add latest_signals.csv portfolio_history.csv data_metadata.json debug_run.txt
          
          # E. COMMIT ET PUSH
          if ! git diff --staged --quiet; then
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M UTC')
            git commit -m "chore(data): daily portfolio update ${TIMESTAMP}"
            
            # Pas besoin de pull complexe ici car on vient de faire un reset --hard
            git push origin main
            echo "âœ… Data committed and pushed successfully"
          else
            echo "â„¹ï¸ No changes to commit"
          fi
      
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 5. Job Summary
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ“Š Generate job summary
        if: always()
        run: |
          echo "## ðŸ“Š Portfolio Analytics Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Number**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f latest_signals.csv ]; then
            echo "### ðŸ“ˆ Latest Signals (Top 5)" >> $GITHUB_STEP_SUMMARY
            echo '```csv' >> $GITHUB_STEP_SUMMARY
            head -n 6 latest_signals.csv >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi