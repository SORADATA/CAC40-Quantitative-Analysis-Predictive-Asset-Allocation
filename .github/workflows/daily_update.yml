name: Daily Portfolio Analytics

on:
  schedule:
    # Lundi-Vendredi Ã  17:00 UTC (18:00 CET / 19:00 CEST)
    - cron: '0 17 * * 1-5'
  
  workflow_dispatch:  # Bouton manuel

permissions:
  contents: write
  actions: read

jobs:
  portfolio-optimization:
    name: Run ML Pipeline & Update Portfolio
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 1. Setup Environment
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
      
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 2. Run Analytics Pipeline
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸš€ Execute Portfolio Optimization
        run: |
          echo "ðŸš€ Starting portfolio analytics pipeline..."
          python daily_run.py
          echo "âœ… Pipeline completed successfully"
        env:
          PYTHONUNBUFFERED: 1
          TZ: Europe/Paris
      
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 3. Verify Generated Files
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ” Check generated files
        run: |
          echo "ðŸ“‚ Checking generated files..."
          ls -lh latest_signals.csv portfolio_history.csv data_metadata.json || echo "Some files missing"
          ls -lh data/raw/*.parquet || echo "Data files missing"
          
          # Show file sizes
          if [ -f data/raw/cac40_daily_raw.parquet ]; then
            echo "âœ“ Daily data: $(du -h data/raw/cac40_daily_raw.parquet | cut -f1)"
          fi
          if [ -f data/raw/cac40_monthly_features.parquet ]; then
            echo "âœ“ Monthly data: $(du -h data/raw/cac40_monthly_features.parquet | cut -f1)"
          fi
      
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 4. Commit & Push Results (VERSION ROBUSTE)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ’¾ Commit updated data
        run: |
          git config --local user.name 'AlphaML Bot'
          git config --local user.email '41898282+github-actions[bot]@users.noreply.github.com'
          
          # Add ALL generated files (signals, history, data, metadata)
          git add -f latest_signals.csv portfolio_history.csv data_metadata.json debug_run.txt
          git add -f data/raw/*.parquet || echo "No parquet files to add"
          
          if ! git diff --staged --quiet; then
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M UTC')
            git commit -m "chore(data): daily portfolio update ${TIMESTAMP}"
            
            # BOUCLE DE SÃ‰CURITÃ‰ : 3 tentatives avec pull/rebase
            n=0
            until [ "$n" -ge 3 ]
            do
               git pull --rebase origin main && git push && break
               n=$((n+1))
               echo "âš ï¸ Push failed, retrying ($n/3)..."
               sleep 10
            done
            
            if [ "$n" -ge 3 ]; then
              echo "âŒ Failed to push after 3 attempts"
              exit 1
            fi
            
            echo "âœ… Data committed and pushed successfully"
          else
            echo "â„¹ï¸ No changes to commit"
          fi
      
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 5. Job Summary (Enhanced)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ“Š Generate job summary
        if: always()
        run: |
          echo "## ðŸ“Š Portfolio Analytics Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Number**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Show metadata if available
          if [ -f data_metadata.json ]; then
            echo "### ðŸ“ Data Files Generated" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat data_metadata.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Show latest signals
          if [ -f latest_signals.csv ]; then
            echo "### ðŸ“ˆ Latest Signals (Top 5)" >> $GITHUB_STEP_SUMMARY
            echo '```csv' >> $GITHUB_STEP_SUMMARY
            head -n 6 latest_signals.csv >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi