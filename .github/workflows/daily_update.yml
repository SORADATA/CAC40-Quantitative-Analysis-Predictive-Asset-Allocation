name:  Daily Portfolio Analytics

on:
  schedule:
    # Lundi-Vendredi Ã  17:00 UTC (18:00 CET / 19:00 CEST)
    - cron: '0 17 * * 1-5'
  
  workflow_dispatch:  # Bouton manuel

permissions:
  contents: write
  actions: read

jobs:
  portfolio-optimization:
    name: Run ML Pipeline & Update Portfolio
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 1. Setup Environment
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      # TRES BIEN D'AVOIR CHOISI 3.11 (Ã‰vite les bugs de 3.13 avec Pandas)
      - name: ðŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -r requirements.txt
      
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 2. Run Analytics Pipeline
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name: Execute Portfolio Optimization
        run: |
          echo "ðŸš€ Starting portfolio analytics pipeline..."
          python daily_run.py
          echo "âœ… Pipeline completed successfully"
        env:
          PYTHONUNBUFFERED: 1
          TZ: Europe/Paris
      
      
      # 3. Save Results (Version Robuste)
      - name: ðŸ’¾ Commit updated data
        run: |
          git config --local user.name 'AlphaML Bot'
          git config --local user.email '41898282+github-actions[bot]@users.noreply.github.com'
          
          git add latest_signals.csv portfolio_history.csv debug_run.txt
          
          if ! git diff --staged --quiet; then
            TIMESTAMP=$(date +'%Y-%m-%d %H:%M UTC')
            git commit -m "chore(data): daily portfolio update ${TIMESTAMP}"
            
            # BOUCLE DE SECURITÃ‰ : Essaie 3 fois de Pull/Rebase/Push
            n=0
            until [ "$n" -ge 3 ]
            do
               git pull --rebase origin main && git push && break
               n=$((n+1))
               sleep 10
            done
            
            echo "âœ… Data committed and pushed"
          else
            echo "â„¹ï¸ No changes to commit"
          fi
      
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      # 4. Summary (Optional)
      # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      - name:  Generate job summary
        if: always()
        run: |
          echo "## ðŸ“Š Portfolio Analytics Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Date**: $(date +'%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Run Number**: #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
          
          if [ -f latest_signals.csv ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“ˆ Latest Signals (Top 5)" >> $GITHUB_STEP_SUMMARY
            echo '```csv' >> $GITHUB_STEP_SUMMARY
            head -n 6 latest_signals.csv >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi